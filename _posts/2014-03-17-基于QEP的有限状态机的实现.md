---
layout : post
title : 基于QEP的有限状态机的实现
tag : 状态机
---

####QEP中关于有限状态机的部分
虽然有限状态机（FSM）是层次状态机（HSM）的一个子集。
所以有限状态机能完成的事情层次状态机也能完成。
但是有限状态机执行速度比层次状态机快，而且程序小（有限状态机大概是200B左右，而层次状态机有600B左右）。
所以有限状态机单独的实现出来了。

#####事件
讨论状态机总是离不开事件（Event）这个概念。在QEP中事件用下面这个结构体来表示：

{% highlight C %} 
typedef struct QEvtTag {
    QSignal sig;                          /**< signal of the event instance */
    uint8_t poolId_;                      /**< pool ID (0 for static event) */
    uint8_t volatile refCtr_;                        /**< reference counter */
} QEvt;
{% endhighlight %} 

这个结构体定义在 *qevt.h* 中。这个结构体中有三个成员。

* 第一个成员是表示事件实例所表示的信号。
* 第二个成员是表示事件的优先级。在有限状态机中，事件都是预先定义好的，不会动态的产生事件，所以不用管它。
* 第三个成员是一个计数器，至于是用来干什么的我也不知道。

也可以在基本事件类型的基础上派生出其他事件类型，比如说按键事件可以表示如下：

{% highlight C %} 
typedef struct KeyEvtTypeDef
{
    QEvt    super;
    uint8_t keyID;
} KeyEvt;
{% endhighlight %} 

#####有限状态机

QEP在 *qep.h* 中定义了有限状态机。定义如下：

{% highlight C %} 
typedef struct QMsmTag {
    QMsmVtbl const *vptr;                       /**< \brief virtual pointer */
    QMAttr state;         /**< \brief current active state (state-variable) */
    QMAttr temp; /**< \brief temporary: transition chain, target state, etc.*/
} QMsm;
{% endhighlight %} 

这明明定义的是QMsm嘛，不是QFsm啊。在后面又加上了这条语句。

{% highlight C %} 
typedef QMsm QFsm;
{% endhighlight %} 


